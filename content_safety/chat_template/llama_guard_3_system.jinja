{%- set system_message = "" -%}
{%- set filtered_messages = [] -%}
{%- for message in messages -%}
    {%- if message['role'] == 'system' -%}
        {%- set system_message = message['content'] -%}
    {%- else -%}
        {%- set filtered_messages = filtered_messages + [message] -%}
    {%- endif -%}
{%- endfor -%}
<|begin_of_text|>
{%- for message in filtered_messages -%}
    {%- if message['role'] == 'user' -%}
        {%- if loop.first and system_message -%}
<|start_header_id|>user<|end_header_id|>

{{ system_message }}

{{ message['content'] }}<|eot_id|>
        {%- else -%}
<|start_header_id|>user<|end_header_id|>

{{ message['content'] }}<|eot_id|>
        {%- endif -%}
    {%- elif message['role'] == 'assistant' -%}
<|start_header_id|>assistant<|end_header_id|>

{{ message['content'] }}<|eot_id|>
    {%- endif -%}
{%- endfor -%}
<|start_header_id|>assistant<|end_header_id|>
